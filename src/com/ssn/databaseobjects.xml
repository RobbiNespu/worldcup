<?xml version = "1.0" encoding = "utf-8"?>
<!DOCTYPE hibernate-mapping PUBLIC 
"-//Hibernate/Hibernate Mapping DTD//EN"
"http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd">
<hibernate-mapping>
	<database-object>
		<create>
			create or replace view vw_results as
			select
			u.id id, u.USERNAME username, m.id mid, f.SCORE1 fsc1, f.score2 fsc2,
			m.score1 msc1, m.score2 msc2,
			sign(f.score1-f.score2) dif_f, sign(m.score1-m.score2) dif_m,
			decode (sign (sign(f.score1-f.score2) - sign(m.score1-m.score2)), 0, 1, 0)
			points,
			case when f.score1=m.score1 and f.score2=m.score2 and m.score1 + m.score2 &lt; 4
			then 2
			when f.score1=m.score1 and f.score2=m.score2 and m.score1+m.score2>=4
			then m.score1+m.score2-1
			else 0 end scorepoints
			from forecast f
			inner join match m
			on m.id=f.match_id
			inner join player u
			on u.id = f.user_id

		</create>

		<drop>
			drop view vw_results
		</drop>
	</database-object>
	<database-object>
		<create>
			create or replace view vw_classification as
			select id, username name, sum(points) winners, sum(scorepoints) scores,
			sum(points) + sum(scorepoints) total from vw_results
			group by id, username
			order by total desc
		</create>


		<drop>
			drop view vw_classification
		</drop>
	</database-object>
</hibernate-mapping>